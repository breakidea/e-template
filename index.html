<html>
<head>
    <title>e-templates</title>
    <script type="text/javascript" src="source.js"></script>
</head>
<body>
<script type="text/javascript">
var data = {
    name: "Activity",
    title: "团队动态",
    list: [
        {date: "[06-22]", title: "你喜欢九月吗，风和日丽的初秋"},
        {date: "[07-27]", title: "反物质原子结构现端倪"},
        {date: "[04-24]", title: "相信经常玩木马的朋友们，DLL木马揭秘"},
        {date: "[05-06]", title: "反物质原子结构现端倪"},
        {date: "[05-17]", title: "grub不能往MBR添加，否则会破坏Win7的激..."},
        {date: "[05-29]", title: "相信经常玩木马的朋友们，DLL木马揭秘"},
        {date: "[06-10]", title: "反物质原子结构现端倪"}
    ]
}
</script>
<script type="text/text" id="template">
    <%this.title%>/<%this.name%>
    <%for(var i = 0; i < this.list.length; i++) {%>
        <li>
            <span><%this.list[i].date%></span>·<%this.list[i].title%>
        </li>
    <%}%>
</script>
<div id="inner"></div>
<script type="text/javascript">
var temp = document.getElementById('template');
var htm = template(temp.innerHTML, data);
document.getElementById('inner').innerHTML = htm
</script>


<script type="text/javascript">
/*!
 * ShangHai rigelCRM global javascript
 * Copyright 2012 Baidu Inc. All rights reserved.
 *
 * file:    新销售系统前端框架
 * author:  Liu,Ronghan(liuronghan@baidu.com)
 * date:    2013/09/28
 * repos:   app/ecom/shifen/sf-crm/ipangu-static
 */

/**
 * @namespace rigel
 * 定义命名空间为 `rigel`
 */
var rigel = rigel || {
    version: "1.1.0"
};

(function() {
    //使用严谨模式
    "use strict";

    /*
     * 命令空间导出对象
     * @type Object
     */
    var exports = {};

    /*
     * 模块文件路径对应关系
     * @type Object
     */
    var depended = {};

    /*
     * 当前需要加载的文件队列
     * @type Array
     */
    var needpaths = [];

    /*
     * 需要执行的回调函数队列
     * @type Array
     */
    var callbacks = [];

    /*
     * 当前是否正在加载文件
     * @type boolean
     */
    var loading = false;

    /*
     * 已加载完成的文件队列
     * @type Array
     */
    var loadedpackages = [];

    /*
     * CDN文件系统版本号码
     * @type string
     */
    var version = "1.0a";

    /**
     * Through the package name defines this package for JS path
     * @param packages {string} the packages name.
     * @return module`s javascript path
     */
    var __getScriptPath = function(packages) {
        var path = null;
        if (path = depended[packages]) {
            return path;
        }
        return exports.router(packages); //router it.
    };
    
    // dim the page load time
    exports.START_TIME = new Date().getTime();

    /**
     * router the package to real .js path, router modules to url
     * @param packages {string} 
     */
    exports.router = function(packages) {
        var root = globalData['static'] + '/js/';
        return root + packages + '.js?version=' + exports.version;
    };
    /**
     * @private
     *
     * Parsing module definition in the dependence
     * Search in the define function for implementation dependent modules
     */
    function __getDependency(code) {
        var pattern = /\brigel\.require\s*\(\s*['"]?([^'")]*)/g;
        var ret = [];
        var match;
        while ((match = pattern.exec(code))) {
            if (match[1]) {
                ret.push(match[1]);
            }
        }
        return ret;
    }
    
    // 通过在head中插入script标签的形式加载脚本文件
    function __loadScript() {
        var path;
        var callback;
        var key;
        if (0 == needpaths.length) {
            while (callback = callbacks.pop()) {
                var apply = [];
                while (key = callback.name.shift()) {
                    apply.push(__getModule(key));
                }
                callback.fn.apply(null, apply);
            }
            return null;
        }
        path = needpaths.shift();
        loading = true;
        exports.getScript(path, __loadScript);
    };
    /**
     * 加载模块
     *
     * @private
     * @param packages {Array} 模块名
     * @param callback {Function=} 加载完成后的回调
     */
    function __loadPackage(packages, callback) {
        var item;
        var paths = [];
        var path;

        for (var i = 0; item = packages[i]; i++) {
            if (baidu.array.contains(loadedpackages, item)) continue;
            path = __getScriptPath(item);
            paths.push(path);
        }
        var __loadScripts = function(paths, callback) {
            var path;
            var i;

            // 检查需要加载的文件是否已加载过或者在待加载队列中
            for (i = 0; path = paths[i]; i++) {
                if (!baidu.array.contains(needpaths, path)) {
                    needpaths.push(path);
                }
            }

            // 添加回调函数到队列
            callbacks.push({
                fn: callback,
                name: packages
            });
            if (!loading) {
                __loadScript();
            }
        };
        __loadScripts(paths, callback);
    };

    /**
     * @public
     *
     * 设置静态JS代码的版本号码
     * @param v {string} 
     */
    exports.setVersion = function(v) {
        version = v;
    };
    /**
     * @private
     *
     * get Module
     * named by |packages|.
     */
    function __getModule(packages) {
        var levels = packages.split('/');
        var reference = window;
        var i = 0;
        while (i < levels.length) {
            reference = reference[levels[i++]];
            if (!reference) {
                break;
            }
        };
        return reference;
    };
    /**
     * Calls |fun| and adds all the fields of the returned object to the object
     * named by |packages|.
     * @public 
     * @param {string} packages The name of the object that we are adding to.
     * @param {!Function} fun The function that will return an object containing
     *     the names and values of the new fields.
     */
    exports.define = function(packages, deps, define) {
        var temporary = {};
        var key;
        var toString = Object.prototype.toString;

        if ("undefined" == typeof define 
                && toString.call(deps) != "[object Array]"
            ) {
            return exports.define(packages, [], deps);
        }
        var levels = packages.split('/');
        var item;
        var ref = window;
        var depends;

        for (var i = 0; item = levels[i]; i++) {
            if (!ref[item]) {
                ref[item] = {};
            }
            ref = ref[item];
        };
        loadedpackages.push(packages);

        if (rigel.AUTO_LOAD_MODULE && define) {
            depends = __getDependency(define.toString());
            if (depends.length > 0 || deps.length > 0) {
                __loadPackage(depends.concat(deps), function() {
                    var args = [ref];
                    while (key = deps.shift()) {
                        args.push(__getModule(key));
                    }
                    define.apply(null, args);
                });
            } else {
                define.call(null, ref);
            }
        } else if (define) {
            define.call(null, ref);
        }
        return ref;
    };

    // 允许自动加载模块
    exports.AUTO_LOAD_MODULE = true;
    /**
     * 加载模块 返回模块的引用
     * 如果不是在define函数中使用require，请使用callback参数或者将require语句放
     * 在单独的script标签中以保证后续代码在模块加载完成后执行
     *
     * @public
     * @param packageName {String} 模块名称(define函数定义的模块)
     * @param callback {Function} 模块加载解析完成后的回调函数
     */
    exports.require = function(packageName, callback) {
        var levels = packageName.split('/');
            var ref = window;
            var i = 0;
            var callback = callback || new Function();

        while (i < levels.length) {
            ref = ref[levels[i++]];
            if (!ref) {
                break;
            }
        }
        if (!ref) {
            if (rigel.AUTO_LOAD_MODULE) {
                __loadPackage([packageName], callback);
            } else {
                throw new Error(packageName + ' is undefined');
            }
        } else {
            callback.call(null, __getModule(packageName));
        }

        return ref;
    };

    /*
     * 设置模块名称与Javascriot脚本之间的对应关系
     *
     * @public
     * @param map {Object} 模块脚本对应关系
     */
    exports.setDepends = function(map) {
        for (var key in map) {
            depended[key] = map[key];
        }
    };
    /**
     * the Ajax common function
     * @public
     *
     * @param action {string} the url address
     * @param data {Object|String} ajax request data.
     * @param success {Function} callback function when status == 0
     * @param failure {Function=} status error , pass (statusInfo, status, xhr)
     * @param {Object=} opt options, for token
     */
    exports.ajaxJSON = function(action, data, success, failure, opt) {
        if (typeof failure != "function") {
            failure = function(statusInfo, status) {
                rigel.alert(statusInfo);
            }
        }
        exports.ajaxHTML(action, data, function (responseText, xhr) {
            try {
                var response = baidu.json.parse(responseText);
                for (var key in response) {
                    if (!/^data|status|statusInfo$/.test(key)) {
                        throw {};
                    }
                }
            } catch (ex) {
                failure.call(null, "服务器错误，请稍候重试。", 500, opt);
                return null;
            }
            if (response.status == 0) {
                success.call(null, response.data, response.statusInfo, opt);
                return null;
            }  else if (response.status == 333) {
                //没有权限
                var iMsg = "访问权限不足，请在切换岗位";
                parent.rigel.alert(iMsg);
            } else {
                failure.call(
                    null, 
                    response.statusInfo, 
                    response.status, 
                    opt, 
                    response.data
                );
            }
        }, failure, opt);
    };
    /**
     * the Ajax common function
     * @public
     *
     * @param action {string} the url address
     * @param data {Object|String} ajax request data.
     * @param success {Function} callback function when status == 0
     * @param failure {Function=} status error , pass (statusInfo, status, xhr)
     * @param {Object=} opt options, for token
     */
    exports.ajaxHTML = function (action, data, success, failure, opt) {
        if (typeof data == "object") {
            data = baidu.url.jsonToQuery(data, encodeURIComponent);
        }
        if (typeof failure != "function") {
            failure = function(statusInfo, status) {
                rigel.alert(statusInfo);
            }
        }
        if(opt && typeof opt == "object") {
            var timeout = opt["timeout"] || 60 * 1000;
        } else {
            var timeout = 60 * 1000;
        }
        //防重复提交
        var repetition = opt && typeof opt == "object" && opt["no_repetition"];
        if(repetition) {
            ecui.mask(0.0005, 65535);
        }
        baidu.ajax.request(action, {
            onsuccess: function (xhr, responseText) {
                repetition &&ecui.mask();
                success.call(null, responseText, xhr);
            }, 
            onfailure: function (xhr) {
                var status = xhr.status;
                repetition && ecui.mask();
                if (status == 404) {
                    var message = "对不起，目标页面找不到了。";
                } else if (status == 0) {
                    var message = "登录超时或网络异常，请刷新后重试。";
                } else if (status != 302 && status != 304) {
                    var message = status + ":" + xhr.statusText;
                }
                failure && failure.call(null, message, status, opt);
            },
            timeout: parseInt(timeout) || 60 * 1000,
            method: 'POST',
            data: data + "&stoken=" + rigel.getGuid()
        });
    };
    /**
     * @public non-blocking script loader
     *
     * @public
     * @param {string} url
     * @param callback {Function=} callback function
     */
    exports.getScript = function(src, callback) {
        var node = document.createElement("script");
        node.type = "text/javascript";
        node.async = "async"; //for firefox3.6
        node.charset = "utf-8";
        node.src = src;
        var head = document.getElementsByTagName("head")[0];
        node.onload = node.onreadystatechange = function(__, isAbort) {
            if (isAbort 
                    || !node.readyState 
                    || /loaded|complete/.test(node.readyState)
                ) {
                node.onload = node.onreadystatechange = null;
                head && node.parentNode && head.removeChild(node);
                callback && callback();
                callback = undefined;
                node = undefined;
            }
        };
        head.insertBefore(node, head.firstChild);
    };
    
    /**
     * returns a non-standard random IDs of arbitrary length and radix.
     * @return {string} the result
     * @see http://www.broofa.com/2008/09/javascript-uuid-function/
     */
    exports.getGuid = function() {
        var string = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx';
        return string.replace(/[xy]/g, function(code) {
            var random = Math.random() * 16 | 0;
            var value = code == 'x' ? random : (random & 0x3 | 0x8);
            return value.toString(16);
        });
    };
    /**
     * Simple common assertion API
     * @param {*} condition The condition to test. Note that this may be used to
     *     test whether a value is defined or not, and we don't want to force a
     *     cast to Boolean.
     * @param {string=} opt_message A message to use in any error.
     */
    exports.assert = function(condition, opt_message) {
        'use strict';
        if (!condition) {
            var msg = 'Assertion failed';
            if (opt_message) {
                msg = msg + ': ' + opt_message;
            }
            throw new Error(msg);
        }
    };

    // 扩展断言功能
    for(var key in baidu.lang) {
        if(/^is/.test(key)) {
            ;(function(name){
                exports.assert[name] = function(subject, opt_message) {
                    var func = baidu.lang[name];
                    exports.assert(func(subject), opt_message);
                }
            })(key);
        }
    }

    /**
     * 计算字符串哈希函数
     *
     * @param string {string} 需要哈希的字符串
     * @return {number} 哈希值
     */
    exports.getHash = function(string) {
        var hash = 1;
        var code = 0;
        for (var i = string.length - 1; i >= 0; i--) {
            code = string.charCodeAt(i);
            hash = (hash << 6 & 268435455) + code + (code << 14);
            code = hash & 266338304;
            hash = code != 0 ? hash ^ code >> 21 : hash;
        };
        return hash;
    };

    /*
     * Idle control function
     *
     * @param callback {function} callback function
     * @param delay {number} delay timeout
     * @return {function} real invoke function
     */
    exports.debounce = function(callback, threshold) {
        var timeout = null;
        return function() {
            var context = this, params = arguments;
            window.clearTimeout(timeout);
            timeout = window.setTimeout(function() {
                callback.apply(context, params);
            }, threshold);
        };
    },
    /*
     * @see http://drupalmotion.com/article/debounce-and-throttle-visual-explanation
     *
     * @param callback {function} callback function
     * @param delay {number} delay timeout
     * @return {function} real invoke function
     */
    exports.throttle = function(callback, delay){
        var suppress = false;
        var clear = function() {
            suppress = false;
        };
        return function() {
            if (!suppress) {
                callback.apply(this, arguments);
                window.setTimeout(clear, delay);
                suppress = true;
            };
        }
    };

    // the cache collections
    var _collection = [];

    // 计数器
    var _guid = 0;

    /**
     * verify the token
     *
     * @private
     * @param source {String} The iterator topic
     * @param token {String} The subscribed token
     * @return permission {Boolean}
     */
    var _check_token = function(source, token) {
        var regx = '^' + String(source)
            .replace(/\//g, '\\/')
            .replace(/\*/g, '.+') + '\/'; //Add last slash.
        return new RegExp(regx).test(token + '/');
    };

    /**
     * subscribe
     * e.g.: subscribe('/Custom/remove', updateChangeLog, this);
     * e.g.: subscribe('/Custom/*', onChangeCust, this);
     * e.g.: subscribe('*', onPublish, this);
     *
     * @public
     * @param topic {String} The topic to subscribe to
     * @param callback {Function} The function to invoke while published
     * @return handler {Number} the global ID, used to unsubscribe.
     */
    exports.subscribe = function(topic, callback) {
        if (typeof callback == 'function' || callback instanceof Function) {
            //update the globally unique identifier
            _guid ++; 
            _collection.push({
                'id': _guid,
                'topic': topic,
                'callback': callback
            });
        }
        return _guid;
    };

    /**
     * publish a message immediatily.
     * e.g.: publish('/Custom/remove');
     * e.g.: publish('/Custom/remove', [custId], this);
     * e.g.: publish('/View/init', arg0NotArray, arg1, arg2 [, ...]); -- scoped of window.
     *
     * @public
     * @param topic {String} The topic to subscribe
     * @param args  {Array}  the arguments lists.
     * @param context {Object} Optional context subject
     */
    exports.publish = function(topic, args, context) {
        // the collection may be changed, never cache the length.
        for (var i = 0; i < _collection.length; i++) {
            var listener = _collection[i];

                //the typeof listener
            if (_check_token(listener.topic, topic)) {

                // deliver the message immediatily.
                listener.callback.apply(context, args || []);
            }
        };
    };

    /**
     * Publish a the message synchronously.
     * e.g.: publishSync('/Custom/remove', [custId, data], modules);
     *
     * @public
     */
    exports.publishSync = function() {
        //using setTimeout('fn();', 0) to make't synchronized.
        var me = this;
        var args = [].slice.call(arguments, 0);
        setTimeout(
            function() {
                publish.apply(me, args); 
            }, 
            0
        );
    };

    /**
     * unsubscribe
     * e.g.: var handle = subscribe('/Custom/remove', updateChangeLog);
     *    unsubscribe(handle);
     *    unsubscribe(updateChangeLog);
     *    unsubscribe('/Custom/*', true);
     *    unsubscribe('/Custom/Added');
     *
     * @param {Number|String|Function} handle, caller callback, and topic string.
     * @param {Boolean} if unsubscribe all matched items
     * @return this
     */
    exports.unsubscribe = function(handle, completly) {
        //as to 'handle', function ? guid ? or topic string..
        var item;
        var tokens = null;
        if ('string' == typeof handle && true === completly) {
            tokens = handle;
        }
        // the length would'e changed, never cache the length.
        for (var i = _collection.length - 1; i >= 0; i--) {
            item = _collection[i];

            if (item.id === handle) {
                _collection.splice(i, 1); //remove.
                break;
            } else if (item.topic === handle 
                    || item.callback === handle 
                    || tokens 
                    && _check_token(tokens, item.topic)
                ) {
                // topic, callback matched, remove completly & permission allowd
                _collection.splice(i, 1); //remove.
            }
        }
        return this;
    };

    //The source object prototype members will not copy.
    baidu.extend(rigel, exports);
})();

// 新盘古心跳函数
(function(){
    // use the trict mode
    "use strict";
    /*
     * 心跳间隔时间
     * @type number
     */
    var interval = 0;

    /*
     * 刷新session的java地址
     * @type string
     */
    var action = '';

    var timer = null;
    var endtime = null;
    /*
     * 异步请求对象
     * @type number
     */
    var request = null;
    if (window.ActiveXObject) {
        try {
            request = new ActiveXObject("Msxml2.XMLHTTP");
        } catch (e) {
            try {
                request = new ActiveXObject("Microsoft.XMLHTTP");
            } catch (e) {}
        }
    }
    if (window.XMLHttpRequest) {
        request = new XMLHttpRequest();
    }
    // Private Methods
    var process = function() {
        var nowtime = (new Date()).getTime();
        if ((endtime != null && nowtime > endtime)) {
            clearInterval(timer);
            return;
        }
        request.open("GET", action, true);
        request.onreadystatechange = onsuccess;
        request.send(null);
    };

    var onsuccess = function() {
        if (request.readyState == 4 || request.readyState == "complete") {
            interval = request.responseText.toUpperCase();
            if (interval > 0) {
                setTimeout(process, interval);
            }
        }
    };
    /**
     * Initial
     * @param _action {string} Action URL
     * @return void
     */
    exports.Init = function(_action) {
        action = _action;
        return this;
    };
    /**
     * Start Heart beat
     * @return void
     */
    exports.Start = function() {
        if (null == request) {
            // Error handler
        } else {
            process();
        }
    };

    // 导出给rigel命名空间
    rigel.heartBeat = exports;
})();
</script>
</body>
</html>